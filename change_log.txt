CHANGE LOG
Version: v1.1.4 -> v1.1.5
Date: 2026-01-29

Objectif
- Avancer la transition Streamlit -> FastAPI + Next.js sans casser l'UI legacy.

Nouveautes
- API FastAPI (api/) avec routes activity/load, real/theoretical, series, map + health.
- Stockage persistant local (storage/activity_store.py) + registry des series (registry/series_registry.py).
- Frontend Next.js (frontend/) avec build et lint.
- Tests: smoke test API (tests/pytest/test_api_smoke.py).

Changements
- requirements.txt et README: dependances et quickstarts API/Frontend.

Correctifs
- Normalisation des colonnes datetime tz lors du stockage parquet (evite l'erreur timezone 'Z').

Notes migration
- Streamlit reste la reference UX et demeure fonctionnel (CourseScope.py, ui/).


Version: v1.1.3 -> v1.1.4
Date: 2026-01-27

Objectif
- Fiabilite/maintenabilite du pipeline DataFrame, sans casser l'UI.

Nouveautes
- Decouplage: extraction des DataFrames intermediaires hors des fonctions de plotting:
  - core/real_run_analysis.py: compute_pace_vs_grade_data / compute_residuals_vs_grade_data.
- Observabilite: TransformReport (rows_in/rows_out + raison) + points d'accroche:
  - core/theoretical_model.py: compute_theoretical_timing(report=...).
  - services/real_activity_service.py: compute_map_df(report=...).
- Ref data: provider unique pour Ref pro:
  - core/ref_data.py (cache + sha256 debug).
- Serialisation: df_to_records force NaN/NaT -> None (JSON) sans muter le DF d'entree.
- Tests: ajout d'une suite pytest (tests/pytest) + ajout de pytest dans requirements.


Version: v1.1.2 -> v1.1.3
Date: 2026-01-27

Objectif
- Performance/stabilite du parsing GPX/FIT + outils de profilage reproductibles.

Nouveautes
- Ajout d'un harness de profilage backend (sans Streamlit): tools/profile_pipeline.py.
- Perf GPX: extraction des extensions (hr/cadence/power) en un seul passage par point.
- Perf FIT: reduction drastique des appels record.get_value via lookup par record (champs + unites).
- Contrat: centralisation de l'ordre des colonnes (COLUMNS) dans core/contracts/activity_df_contract.py, partage par les deux loaders.

Objectif
- Ajouter des metriques supplementaires (style Garmin) principalement depuis FIT, sans casser GPX.

Nouveautes
- Extension du schema DataFrame canonique (colonnes toujours presentes; GPX -> NaN):
  - stride_length_m
  - vertical_oscillation_cm
  - vertical_ratio_pct
  - ground_contact_time_ms
  - gct_balance_pct
- Extraction FIT (optionnelle) des running dynamics + normalisation d'unites.
- Stats resume enrichies: vitesse max, best pace, min/max altitude, stats de pente (mean/min/max), VAM.
- Bloc power avancee (si power dispo): normalized power (NP), intensity factor (IF), TSS.


Version: v1.1.1 -> v1.1.2
Date: 2026-01-27

Objectif
- Nettoyer la racine du projet et rendre les ressources packagables, tout en laissant la table "Ref pro" personnalisable.

Nouveautes
- Suppression du shim `grade_table.py` a la racine (utiliser `core/grade_table.py`).
- Deplacement de la table de reference vers `core/resources/pro_pace_vs_grade.csv`.
- Possibilite de surcharge utilisateur via variable d'environnement: `COURSESCOPE_PRO_PACE_VS_GRADE_PATH`.
- Documentation mise a jour (arborescence + commandes).

Version: v1.1 -> v1.1.1
Date: 2026-01-27

Objectif
- Unifier/fiabiliser le backend pour une reutilisation future (FastAPI/React), sans casser l'UI Streamlit.

Nouveautes
- Contrat DataFrame canonique:
  - core/contracts/activity_df_contract.py (coercion + validation + messages d'erreur explicites).
  - Validation branchee dans services/activity_service.load_activity_from_bytes().
- Stats de base unifiees:
  - core/stats/basic_stats.py + refacto des duplications dans services/activity_service.py, core/real_run_analysis.py, core/metrics.py.
- Constantes centralisees:
  - core/constants.py (seuils vitesse, moving threshold, valeurs par defaut).
- Dedup/DRY:
  - compute_derived_series() retourne un objet (core/derived.py) au lieu d'un dict.
  - services/real_activity_service.analyze_real_activity() reutilise build_figures/build_map_payload/build_highlights.
  - services/theoretical_service factorise le calcul d'allure ajustee (_compute_adjusted_pace_base).
- Serialisation JSON + entree API:
  - services/serialization.py (to_jsonable) pour convertir dataclasses/pandas/numpy/plotly en JSON.
  - services/analysis_service.py (points d'entree de haut niveau, cache injectable).
- Cache portable et stable:
  - services/cache.py etendu (KeyValueCache, InMemoryCache TTL, NullCache, make_cache_key).
- Perf:
  - Memoization du chargement pro_pace_vs_grade.csv (lru_cache).
  - Optimisation de compute_moving_mask() (comportement conserve).
- Tests:
  - Ajout d'une suite unittest: tests/unit/test_*.py.
  - Commande: python -m unittest discover -s tests -p "test_*.py" -v
- Tests (donnees):
  - Deplacement des fichiers demo vers tests/ (tests/course.gpx, tests/course.fit).


Version: v1.0 -> v1.1
Date: 2026-01-26

Objectif v1.1
- Conserver Streamlit (meme UX / meme fonctionnalites).
- Sortir la logique metier des vues Streamlit.
- Rendre le backend Python reutilisable pour une future API (ex: FastAPI).


Resume
- Release de refacto interne (aucune feature supprimee).
- Introduction d'une separation claire en 3 couches:
  - core/     : pur Python (parsing + calculs + figures Plotly)
  - services/ : pur Python (use-cases / orchestration / contrats)
  - ui/       : Streamlit (widgets + rendu)
- Ajout de smoke tests pour limiter le risque de regression.


Nouveautes (structure / architecture)

1) Couche services (nouveau backend applicatif)
- Nouveau dossier `services/` (Streamlit-free)
- Encapsule les use-cases:
  - chargement activite + type detection
  - analyse course reelle
  - prevision theorique (base + passages + simulation avancee)

2) Centralisation des helpers (formatage / parsing)
- `core/formatting.py`:
  - format_duration_compact(seconds): style layout (ex: 3h05m02s)
  - format_duration_clock(seconds): style vues (ex: 1:02:03)
  - format_time_of_day(value): HH:MM:SS
- `core/parsing.py`:
  - parse_km_list(raw): parse "5,10,21.1" etc.

3) Stabilisation de grade_table (preparation packaging)
- `core/grade_table.py` devient l'emplacement canonical.
- `grade_table.py` (racine) devient un shim de compat (re-export).
- `core/real_run_analysis.py` et `core/theoretical_model.py` importent maintenant `grade_factor` depuis `core.grade_table`.

4) Packaging
- Ajout de `__init__.py` dans `core/`, `services/`, `ui/`.

5) Tests
- Ajout de `tests/smoke_test.py`.


Changements par zone

UI (Streamlit)

- ui/layout.py
  - _load_activity_from_bytes() devient un wrapper UI (st.cache_data) qui appelle services.activity_service.load_activity_from_bytes().
  - _compute_sidebar_stats() delegue a services.activity_service.compute_sidebar_stats().
  - _add_to_history() delegue a services.history_service.upsert_history().
  - _format_duration() delegue a core.formatting.format_duration_compact().
  - L'UI conserve: uploader, navigation, st.session_state, sidebar, selection de vue.

- ui/real_run_view.py
  - Cache UI:
    - _get_cached_base(): st.cache_data -> services.real_activity_service.prepare_base().
    - _get_garmin_stats(): st.cache_data -> services.real_activity_service.compute_garmin_stats().
  - La logique metier extraite vers services.real_activity_service:
    - derivatives (grade/moving/GAP)
    - summary
    - best_efforts / climbs / pauses / splits
    - calcul de la serie d'allure (mode temps reel vs temps mouvement + lissage + cap)
    - construction figures Plotly
    - preparation "map-ready" (color/labels/climb points/pause points)
  - L'UI conserve: widgets, layout, st.plotly_chart, st.pydeck_chart, tables.

- ui/theoretical_view.py
  - Cache UI:
    - _get_cached_theoretical(): st.cache_data -> services.theoretical_service.prepare_base().
  - La logique metier extraite vers services.theoretical_service:
    - construction df_display (lissage + cap)
    - passages + markers
    - splits
    - meteo + split bias + cap avance
    - simulation avancee + pacing categories + export CSV
  - L'UI conserve: widgets, layout, st.plotly_chart, st.pydeck_chart, download_button.

Core (pur Python)

- core/formatting.py (nouveau)
- core/parsing.py (nouveau)
- core/grade_table.py (nouveau, canonical)
- grade_table.py (racine): shim de compat
- core/real_run_analysis.py: import `grade_factor` depuis `core.grade_table`
- core/theoretical_model.py: import `grade_factor` depuis `core.grade_table`

Services (pur Python)

- services/models.py
  - dataclasses: LoadedActivity, SidebarStats, RealRunBase, RealRunResult, Theoretical*.
- services/activity_service.py
  - chargement GPX/FIT depuis bytes + detection type + track_count.
  - stats sidebar.
- services/history_service.py
  - upsert_history(history, entry, max_items).
- services/real_activity_service.py
  - fonctions d'orchestration (prepare_base, compute_garmin_stats, compute_pace_series, build_figures, build_map_payload, build_highlights).
- services/theoretical_service.py
  - fonctions d'orchestration (prepare_base, compute_display_df, compute_passages, compute_splits, compute_weather_factor, compute_advanced, etc.).
- services/cache.py
  - MemoryCache (LRU) + DiskCache (pickle) + helpers.
  - Brique prete pour une migration API, pas obligatoire pour l'UI actuelle.


Compatibilite
- Aucun comportement utilisateur volontairement modifie.
- `grade_table.py` a la racine reste importable (shim).
- La couche services reste Streamlit-free.


Verification / validation v1.1

1) Lancer l'app
- Windows: run_win.bat
- Linux/macOS: run_linux.sh
- Manuel: streamlit run CourseScope.py

2) Smoke tests (recommande via venv)
- Windows: .venv/Scripts/python.exe tests/smoke_test.py
- Linux/macOS: .venv/bin/python tests/smoke_test.py

3) Compilation
- Windows: .venv/Scripts/python.exe -m compileall -q core services ui tests CourseScope.py grade_table.py


Fichiers ajoutes (principaux)
- core/__init__.py
- core/formatting.py
- core/parsing.py
- core/grade_table.py
- services/__init__.py
- services/models.py
- services/activity_service.py
- services/history_service.py
- services/real_activity_service.py
- services/theoretical_service.py
- services/cache.py
- tests/smoke_test.py
- README.md
- change_log.txt
- cahier_des_charges.txt (mis a jour)

Fichiers modifies (principaux)
- ui/layout.py
- ui/real_run_view.py
- ui/theoretical_view.py
- core/real_run_analysis.py
- core/theoretical_model.py
- grade_table.py
